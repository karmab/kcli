{{ image }}:
  type: image

{%- if ctlplanes > 1 and config_type in ['aws', 'gcp'] %}
{{ cluster }}-ctlplane:
 type: loadbalancer
 nets:
 - name: {{ network }}
   alias:
   - {{ cluster }}-ctlplane.{{ domain }}
   - {{ cluster }}-ctlplane.{{ network }}
   reservedns: true
 ports:
 - 6443
 vms:
{%- for number in range(0, ctlplanes) %}
  - {{cluster}}-ctlplane-{{ number }}
{%- endfor %}
{%- endif %}


{%- for number in range(0, ctlplanes) %}
{%- if extra_ctlplane_networks %}
 {% set extra_networks = extra_ctlplane_networks %}
{%- endif %}
{%- if extra_ctlplane_disks %}
 {% set extra_disks = extra_ctlplane_disks %}
{%- endif %}
{%- if numa_ctlplane != None %}
 {% set numa = numa_ctlplane %}
{%- endif %}
{%- if numamode_ctlplane != None %}
 {% set numa_mode = numamode_ctlplane %}
{%- endif %}
{%- if cpupinning_ctlplane != None %}
 {% set cpupinning = cpupinning_ctlplane %}
{%- endif %}

{{cluster}}-ctlplane-{{ number }}:
 image: {{ image }}
 pool: {{ pool }}
 numcpus: {{ ctlplane_numcpus | default(numcpus, numcpus) }}
 memory: {{ ctlplane_memory | default(memory, memory) }}
{%- if ctlplanes > 1 %}
 sharedkey: true
{%- endif %}
 domain: {{ domain }}
{%- if number == 0 %}
 notify: {{ notify }}
 notifycmd: {{ notifycmd }}
{%- endif %}
 nets: {{ [network] + extra_networks }}
 disks: {{ [disk_size] + extra_disks }}
 files:
  - keepalived.conf
{%- if number == 0 %}
{%- if metallb %}
  - metal_lb.sh
  - metal_lb_cm.yml
{%- endif %}
{%- if nfs %}
  - nfs.yml
  - nfs.sh
{%- endif %}
{%- endif %}
 scripts: 
{%- if ubuntu|default(False) %}
  - pre_ubuntu.sh
{%- else %}
  - pre_el.sh
{%- endif %}
{%- if ctlplanes > 1 and config_type not in ['aws', 'gcp'] %}
  - keepalived.sh
{%- endif %}
{%- if number == 0 %}
  - ctlplanes.sh
{%- if multus %}
  - multus.sh
{%- endif %}
{%- if nfs %}
  - nfs.sh
{%- endif %}
{% else %}
  - ctlplanes_extra.sh
{% endif %}
{%- if numa != None %}
 numa: {{ numa }}
{%- endif %}
{%- if numamode != None %}
 numamode: {{ numamode }}
{%- endif %}
{%- if cpupinning != None %}
 cpupinning: {{ cpupinning }}
{%- endif %}
{%- endfor %}
